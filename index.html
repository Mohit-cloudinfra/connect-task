<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>SharkEnglishQueue — Task Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #ddd; text-align:left; }
    th { background:#f5f5f5; user-select:none; cursor:default; }
    button { padding:6px 10px; margin-right:6px; }
    .small { font-size:0.9em; color:#444; }
    .sort { cursor:pointer; }
    .num { white-space:nowrap; }
  </style>
</head>
<body>
  <h2>SharkEnglishQueue — Task Console</h2>
  <p class="small">Shows tasks in SharkEnglishQueue. “Hold” moves to TempEnglishSharkQueue; “Resume” moves back.</p>

  <div>
    <label>Queue ID: <input id="queueId" value="c14c7415-189e-4212-a766-6bfcbdc62e6d" style="width:360px" /></label>
    <button id="load">Load tasks</button>
    <span id="status" style="margin-left:12px;color:gray"></span>
  </div>

  <table aria-label="Tasks table" id="tbl" style="margin-top:12px">
    <thead>
      <tr>
        <th>ContactId</th>
        <th>Title</th>
        <th>Description</th>
        <th>Enqueued (current)</th>
        <th class="sort" data-key="start">Start Date ▲▼</th>
        <th class="sort" data-key="time">Start Time ▲▼</th>
        <th>State</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
/** <<< EDIT THESE TWO >>> **/
const API_BASE = "https://YOUR_API_GATEWAY_ID.execute-api.YOUR-REGION.amazonaws.com"; // e.g. https://abc123.execute-api.us-west-2.amazonaws.com
const API_KEY  = ""; // optional if your API uses an API key

const el = {
  queueId: document.getElementById('queueId'),
  load: document.getElementById('load'),
  status: document.getElementById('status'),
  tbody: document.querySelector('#tbl tbody'),
  thead: document.querySelector('#tbl thead')
};

let cache = [];         // last loaded rows
let sortKey = 'start';  // 'start' or 'time'
let sortDir = 'asc';    // 'asc' or 'desc'

function fmtDate(epochMs) {
  if (!epochMs) return '';
  const d = new Date(epochMs);
  return d.toLocaleDateString();
}
function fmtTime(epochMs) {
  if (!epochMs) return '';
  const d = new Date(epochMs);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
function fmtDateTime(epochMs) {
  if (!epochMs) return '';
  const d = new Date(epochMs);
  return d.toLocaleString();
}

async function apiFetch(path, opts = {}) {
  const headers = opts.headers || {};
  if (API_KEY && API_KEY.length) headers['x-api-key'] = API_KEY;
  headers['Content-Type'] = headers['Content-Type'] || 'application/json';
  const res = await fetch(API_BASE + path, { ...opts, headers, mode: 'cors' });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(res.status + ' ' + text);
  }
  return res.status === 204 ? null : res.json();
}

async function loadTasks() {
  try {
    el.status.textContent = 'Loading...';
    const q = el.queueId.value.trim();
    const data = await apiFetch(`/tasks?queueId=${encodeURIComponent(q)}`);
    cache = (data.rows || []);
    applySortAndRender();
    el.status.textContent = `Loaded ${ cache.length } tasks`;
  } catch (err) {
    console.error(err);
    el.status.textContent = 'Error: ' + err.message;
    alert('Error loading tasks: ' + err.message);
  }
}

function applySortAndRender() {
  const rows = [...cache];
  if (sortKey === 'start' || sortKey === 'time') {
    rows.sort((a, b) => {
      const av = a.originalStartTimestamp || 0;
      const bv = b.originalStartTimestamp || 0;
      return sortDir === 'asc' ? (av - bv) : (bv - av);
    });
  }
  renderRows(rows);
}

function renderRows(rows) {
  el.tbody.innerHTML = '';
  for (const r of rows) {
    const tr = document.createElement('tr');
    const title = r.title || valFromAttrs(r, ['Title', 'title']) || '';
    const desc  = r.description || valFromAttrs(r, ['Description','description']) || '';
    tr.innerHTML = `
      <td class="num">${r.contactId}</td>
      <td>${escapeHtml(title)}</td>
      <td>${escapeHtml(desc)}</td>
      <td class="num">${fmtDateTime(r.enqueueTimestamp)}</td>
      <td class="num">${fmtDate(r.originalStartTimestamp)}</td>
      <td class="num">${fmtTime(r.originalStartTimestamp)}</td>
      <td>${r.state || ''}</td>
      <td>
        <button data-op="hold" data-id="${r.contactId}">Hold</button>
        <button data-op="resume" data-id="${r.contactId}">Resume</button>
        <button data-op="transfer" data-id="${r.contactId}">Transfer</button>
      </td>
    `;
    el.tbody.appendChild(tr);
  }
}

function valFromAttrs(r, keys) {
  const a = r.segmentAttributes || r.attributes || {};
  for (const k of keys) {
    if (a[k]) return a[k];
  }
  return '';
}

el.tbody.addEventListener('click', async (ev) => {
  const btn = ev.target.closest('button');
  if (!btn) return;
  const op = btn.dataset.op;
  const contactId = btn.dataset.id;
  if (op === 'hold') {
    if (!confirm('Move this task to TempEnglishSharkQueue (Hold)?')) return;
    await callAction('/transfer', { contactId, targetQueueId: '6168656d-4007-42f4-b1f5-0218247efd29' });
  } else if (op === 'resume') {
    if (!confirm('Move this task back to SharkEnglishQueue (Resume)?')) return;
    await callAction('/transfer', { contactId, targetQueueId: 'c14c7415-189e-4212-a766-6bfcbdc62e6d' });
  } else if (op === 'transfer') {
    const q = prompt('Target queue id (example: 6168...):');
    if (!q) return;
    await callAction('/transfer', { contactId, targetQueueId: q.trim() });
  }
  await loadTasks();
});

el.thead.addEventListener('click', (ev) => {
  const th = ev.target.closest('.sort');
  if (!th) return;
  const key = th.dataset.key;       // 'start' or 'time'
  if (sortKey === key) {
    sortDir = (sortDir === 'asc' ? 'desc' : 'asc');
  } else {
    sortKey = key;
    sortDir = 'asc';
  }
  applySortAndRender();
});

async function callAction(path, body) {
  try {
    el.status.textContent = 'Working...';
    await apiFetch(path, { method: 'POST', body: JSON.stringify(body) });
    el.status.textContent = 'Done';
  } catch (e) {
    console.error(e);
    alert('Error: ' + e.message);
    el.status.textContent = 'Error';
  }
}

function escapeHtml(s = '') {
  return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

el.load.onclick = loadTasks;
loadTasks();   // initial load
</script>
</body>
</html>
